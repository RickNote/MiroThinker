

# ä»£ç å®¡æŸ¥ + Railway éƒ¨ç½²é—®é¢˜ä¿®å¤

---

## ä¸€ã€ä»£ç å®¡æŸ¥

æ•´ä½“è¯„ä»·ï¼šä»£ç è´¨é‡ä¸é”™ï¼Œç»“æ„æ¸…æ™°ï¼Œæ ¸å¿ƒé€»è¾‘æ­£ç¡®ã€‚ä»¥ä¸‹æ˜¯éœ€è¦å…³æ³¨çš„é—®é¢˜ï¼ŒæŒ‰ä¸¥é‡ç¨‹åº¦æ’åºï¼š

---

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå½±å“åŠŸèƒ½æˆ–ç¨³å®šæ€§ï¼‰

#### é—®é¢˜ 1ï¼š`miro_research.py` â€” URL è§£ææåº¦è„†å¼±

```python
# å½“å‰æ–¹å¼ï¼šä»æ ¼å¼åŒ–çš„ Markdown æ–‡æœ¬ä¸­ç”¨å­—ç¬¦ä¸²åŒ¹é…æå– URL
for line in search_result.split("\n"):
    if line.strip().startswith("é“¾æ¥:"):
        url = line.strip()[len("é“¾æ¥:") :].strip()
```

**é—®é¢˜**ï¼š`do_miro_search` è¿”å›çš„æ˜¯æ ¼å¼åŒ–å¥½çš„ Markdown å­—ç¬¦ä¸²ï¼Œ`miro_research` åˆå»è§£æè¿™ä¸ªå­—ç¬¦ä¸²æ¥æå– URLã€‚è¿™æ˜¯**è‡ªå·±ç”Ÿæˆæ ¼å¼å†è‡ªå·±è§£æ**ï¼Œä¸€æ—¦æ ¼å¼å¾®è°ƒå°±å…¨éƒ¨æ–­è£‚ã€‚

**ä¿®æ”¹æ€è·¯**ï¼šè®© `do_miro_search` å†…éƒ¨æ‹†åˆ†ä¸ºä¸¤æ­¥ï¼š
1. ä¸€ä¸ªå†…éƒ¨å‡½æ•° `_raw_search(config, query, ...)` è¿”å›ç»“æ„åŒ–çš„ `List[Dict]`ï¼ˆåŸå§‹ organic resultsï¼‰
2. `do_miro_search` è°ƒç”¨ `_raw_search` åæ ¼å¼åŒ–ä¸º Markdown è¿”å›ç»™ MCP
3. `miro_research` ç›´æ¥è°ƒç”¨ `_raw_search` è·å–ç»“æ„åŒ–æ•°æ®ï¼Œä¸éœ€è¦è§£æ Markdown

---

#### é—®é¢˜ 2ï¼š`miro_research.py` â€” ç¬¬ 2 è½®ä»¥åçš„æœç´¢è¯é€€åŒ–

```python
if round_num == 0:
    plan_result = await llm_client.chat_json(...)
    search_queries = plan_result.get("search_queries", [question])
else:
    search_queries = [f"{question} æ›´æ–°ä¿¡æ¯"]  # â† ç¡¬ç¼–ç ï¼Œå®Œå…¨æ²¡æœ‰åˆ©ç”¨å·²æœ‰ä¿¡æ¯
```

**é—®é¢˜**ï¼šæ–¹æ¡ˆä¸­è®¾è®¡çš„æ˜¯æ¯è½®æ ¹æ®å·²æ”¶é›†ä¿¡æ¯è®© LLM ç”Ÿæˆæ–°çš„æœç´¢è¯ã€è¯„ä¼°ä¿¡æ¯æ˜¯å¦å……åˆ†ã€‚å½“å‰å®ç°å®Œå…¨è·³è¿‡äº†è¿™äº›é€»è¾‘ï¼Œç¬¬ 2 è½®å¼€å§‹åªæ˜¯åœ¨åŸé—®é¢˜åè¿½åŠ "æ›´æ–°ä¿¡æ¯"å››ä¸ªå­—ã€‚

**ä¿®æ”¹æ€è·¯**ï¼š
- æ¯è½®ç»“æŸåï¼Œå°†å·²æœ‰å‘ç°æ‘˜è¦ä¼ ç»™ LLMï¼Œè®© LLM ç”Ÿæˆè¡¥å……æœç´¢è¯
- åŠ å…¥"ä¿¡æ¯å……åˆ†æ€§è¯„ä¼°"æ­¥éª¤ï¼ˆLLM åˆ¤æ–­ `is_sufficient` + `confidence`ï¼‰ï¼Œå¦‚æœå¤Ÿäº†å°±æå‰ç»“æŸï¼Œä¸å¤Ÿåˆ™æŒ‡å‡ºç¼ºä»€ä¹ˆ

---

#### é—®é¢˜ 3ï¼š`llm_client.py` â€” `chat_json` åŸåœ°ä¿®æ”¹äº†è°ƒç”¨è€…çš„ messages åˆ—è¡¨

```python
async def chat_json(self, messages: list, ...):
    # ç›´æ¥ä¿®æ”¹äº†ä¼ å…¥çš„ messages åˆ—è¡¨ï¼
    if messages and isinstance(messages[-1], dict) and "content" in messages[-1]:
        orig_content = messages[-1]["content"]
        messages[-1]["content"] = orig_content + "\n\nPlease respond in JSON format only..."
```

**é—®é¢˜**ï¼šPython ä¸­ list å’Œ dict æ˜¯å¯å˜å¯¹è±¡ï¼Œè¿™é‡Œç›´æ¥ä¿®æ”¹äº†è°ƒç”¨è€…ä¼ å…¥çš„ `messages`ï¼Œå¯¼è‡´è°ƒç”¨è€…çš„æ•°æ®è¢«æ±¡æŸ“ã€‚å¦‚æœè°ƒç”¨è€…åç»­å¤ç”¨è¿™ä¸ª messagesï¼Œä¼šåŒ…å«å¤šä½™çš„"Please respond in JSON"æ–‡æœ¬ã€‚

**ä¿®æ”¹æ€è·¯**ï¼šåœ¨æ–¹æ³•å¼€å¤´åšæ·±æ‹·è´ `messages = [m.copy() for m in messages]`ï¼Œåœ¨å‰¯æœ¬ä¸Šæ“ä½œã€‚

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆå½±å“å¥å£®æ€§æˆ–ç”¨æˆ·ä½“éªŒï¼‰

#### é—®é¢˜ 4ï¼š`miro_search.py` â€” `data` å˜é‡å¯èƒ½æœªå®šä¹‰

```python
for attempt, delay in enumerate(retry_delays, 1):
    try:
        ...
        data = response.json()
        break
    except ... as e:
        ...
        raise  # â† æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥æ—¶ raise

# å¦‚æœæ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ä½†å¼‚å¸¸ç±»å‹ä¸åœ¨æ•è·åˆ—è¡¨ä¸­ï¼Œ
# data åœ¨è¿™é‡Œæœªå®šä¹‰
organic_results = []
for item in data.get("organic", []):  # â† å¯èƒ½ NameError
```

**ä¿®æ”¹æ€è·¯**ï¼šåœ¨å¾ªç¯å‰åˆå§‹åŒ– `data = {}`ï¼Œæˆ–è€…åœ¨å¾ªç¯ååŠ ä¸€ä¸ªæ£€æŸ¥ã€‚æ›´å¥½çš„åšæ³•æ˜¯æŠŠå¾ªç¯åçš„é€»è¾‘æ”¾è¿› try å—å†…ã€break ä¹‹åã€‚

---

#### é—®é¢˜ 5ï¼š`llm_client.py` â€” åµŒå¥—é‡è¯•å¯¼è‡´æé•¿ç­‰å¾…

`extract_info` æœ‰è‡ªå·±çš„ 4 æ¬¡é‡è¯•å¾ªç¯ï¼Œæ¯æ¬¡è°ƒç”¨ `self.chat`ï¼Œè€Œ `self.chat` åˆæœ‰ 5 æ¬¡é‡è¯•å¾ªç¯ã€‚æœ€åæƒ…å†µï¼š4 Ã— 5 = 20 æ¬¡ LLM è°ƒç”¨ï¼Œæ¯æ¬¡é—´éš”æ•°ç§’ï¼Œæ€»è®¡å¯èƒ½ç­‰å¾…æ•°åˆ†é’Ÿã€‚

**ä¿®æ”¹æ€è·¯**ï¼š`extract_info` çš„é‡è¯•åº”è¯¥åªé’ˆå¯¹"ä¸Šä¸‹æ–‡è¶…é™"è¿™ä¸€ç§é”™è¯¯ï¼ˆéœ€è¦æˆªæ–­å†…å®¹åé‡è¯•ï¼‰ï¼Œå…¶ä»–é”™è¯¯ç›´æ¥è®© `self.chat` çš„é‡è¯•å¤„ç†å³å¯ã€‚ç›®å‰çš„å®ç°å…¶å®å·²ç»éƒ¨åˆ†åšåˆ°äº†ï¼ˆåª catch ä¸Šä¸‹æ–‡è¶…é™ï¼‰ï¼Œä½†åµŒå¥—ä»ç„¶å­˜åœ¨ï¼Œå»ºè®®åœ¨ `extract_info` è°ƒç”¨ `self.chat` æ—¶ä¼ å…¥ä¸€ä¸ªæ ‡å¿—å‡å°‘å†…å±‚é‡è¯•æ¬¡æ•°ã€‚

---

#### é—®é¢˜ 6ï¼š`miro_research.py` â€” ç¼ºå°‘æ–¹æ¡ˆä¸­çš„è¿›åº¦æ¨é€å’Œæ—¥å¿—å¯†åº¦

æ–¹æ¡ˆä¸­è¯¦ç»†è®¾è®¡äº† `miro_research` çš„æ—¥å¿—æ¨é€æ—¶åºï¼ŒåŒ…æ‹¬æ¯æ¬¡æœç´¢/é˜…è¯»/è¯„ä¼°éƒ½æ¨é€æ—¥å¿—ã€‚å½“å‰å®ç°åªæœ‰è½®æ¬¡çº§åˆ«çš„æ—¥å¿—ï¼Œç¼ºå°‘ï¼š
- `[MiroThinker] ğŸ§  æ­£åœ¨åˆ†æç ”ç©¶é—®é¢˜...`ï¼ˆç¬¬ä¸€è½®è§„åˆ’æ—¶ï¼‰
- `[MiroThinker] ğŸ” æ­£åœ¨æœç´¢: xxx`ï¼ˆæ¯æ¬¡æœç´¢æ—¶ â€” è™½ç„¶ `do_miro_search` å†…éƒ¨ä¼šæ¨ï¼Œä½† research å±‚é¢æ²¡æœ‰é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰
- `[MiroThinker] ğŸ¤” æ­£åœ¨è¯„ä¼°å·²æ”¶é›†çš„ N æ¡ä¿¡æ¯...`ï¼ˆç¼ºå¤±ï¼Œå› ä¸ºæ²¡æœ‰è¯„ä¼°æ­¥éª¤ï¼‰
- `[MiroThinker] ğŸ“Š ä¿¡æ¯å°šä¸å……åˆ†(65%)ï¼Œç¼ºå°‘: xxx`ï¼ˆç¼ºå¤±ï¼‰

**ä¿®æ”¹æ€è·¯**ï¼šè¡¥å……è¿™äº›å…³é”®èŠ‚ç‚¹çš„æ—¥å¿—æ¨é€ã€‚

---

### ğŸŸ¢ è½»å¾®é—®é¢˜ï¼ˆä¼˜åŒ–å»ºè®®ï¼‰

#### é—®é¢˜ 7ï¼š`miro_read.py` â€” LLM æå–å¤±è´¥åç¼ºå°‘é™çº§

```python
try:
    extracted = await llm_client.extract_info(...)
except Exception as e:
    if "context length" in str(e).lower():
        # æˆªæ–­é‡è¯•
    else:
        raise  # â† ç›´æ¥æŠ›å‡ºï¼Œç”¨æˆ·çœ‹åˆ°é”™è¯¯
```

**ä¿®æ”¹æ€è·¯**ï¼šLLM æå–å¤±è´¥æ—¶ï¼Œåº”é™çº§è¿”å›æˆªæ–­çš„åŸå§‹å†…å®¹ï¼ˆ`content[:6000]`ï¼‰ï¼Œè€Œéç›´æ¥æŠ›é”™ã€‚

---

#### é—®é¢˜ 8ï¼š`mcp_server.py` â€” å·¥å…·æè¿°å¯ä»¥æ›´è¯¦ç»†

å½“å‰çš„ docstring æ¯”è¾ƒç®€çŸ­ï¼Œæ–¹æ¡ˆä¸­è®¾è®¡çš„æè¿°æ›´è¯¦ç»†ï¼ˆåŒ…å«"æ›¿ä»£å†…ç½® WebSearch"ã€ä½¿ç”¨å»ºè®®ç­‰ï¼‰ã€‚å»ºè®®å°†æ–¹æ¡ˆä¸­çš„å®Œæ•´æè¿°æ”¾è¿› docstringã€‚

---

#### é—®é¢˜ 9ï¼šDockerfile â€” ç¼ºå°‘å±‚ç¼“å­˜ä¼˜åŒ–

å½“å‰ Dockerfile çš„ `COPY . .` ä¼šå¯¼è‡´æ¯æ¬¡ä»£ç ä¿®æ”¹éƒ½é‡æ–°å®‰è£…ä¾èµ–ã€‚å»ºè®®åˆ†ä¸¤æ­¥ï¼šå…ˆ COPY requirements.txt å®‰è£…ä¾èµ–ï¼Œå† COPY ä»£ç ã€‚**å½“å‰ä»£ç å·²ç»è¿™æ ·åšäº†**ï¼Œè¿™ä¸€ç‚¹æ˜¯æ­£ç¡®çš„ã€‚ä½†å¯ä»¥åŠ  `.dockerignore` æ–‡ä»¶æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆå¦‚ `.env`ã€`__pycache__` ç­‰ï¼‰ã€‚

---

## äºŒã€Railway éƒ¨ç½²é—®é¢˜

### é”™è¯¯åŸå› 

å…³é”®æ—¥å¿—ï¼š

```
skipping 'Dockerfile' at 'apps/mcp-server/Dockerfile' 
  as it is not rooted at a valid path (root_dir=)

skipping 'railway.toml' at 'apps/mcp-server/railway.toml'
  as it is not rooted at a valid path (root_dir=)
```

Railway é»˜è®¤æŠŠ**ä»“åº“æ ¹ç›®å½•**ä½œä¸ºé¡¹ç›®æ ¹ç›®å½•ã€‚ä½ çš„ `Dockerfile` å’Œ `railway.toml` éƒ½åœ¨ `apps/mcp-server/` å­ç›®å½•ä¸‹ï¼ŒRailway æ‰¾ä¸åˆ°å®ƒä»¬ï¼Œæ‰€ä»¥ä¸çŸ¥é“æ€ä¹ˆæ„å»ºï¼Œfallback åˆ°è‡ªåŠ¨æ£€æµ‹ï¼ˆRailpackï¼‰ï¼Œè€Œ Railpack çœ‹åˆ°çš„æ˜¯ MiroThinker åŸå§‹ä»“åº“æ ¹ç›®å½•ï¼ˆåŒ…å« apps/ã€libs/ã€README.md ç­‰ï¼‰ï¼Œè‡ªç„¶æ— æ³•è¯†åˆ«ã€‚

### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šåœ¨ Railway Dashboard è®¾ç½® Root Directory**

```
Railway Dashboard â†’ ä½ çš„ Service â†’ Settings â†’ Source
â†’ Root Directory å¡«å…¥: apps/mcp-server
```

åŒæ—¶ä¿®æ”¹ `railway.toml`ï¼š

```toml
# æ—§çš„ï¼ˆé”™è¯¯ï¼‰
dockerfilePath = "apps/mcp-server/Dockerfile"

# æ–°çš„ï¼ˆæ­£ç¡®ï¼Œç›¸å¯¹äº Root Directoryï¼‰
dockerfilePath = "Dockerfile"
```

è¿™æ · Railway ä¼šæŠŠ `apps/mcp-server/` å½“ä½œé¡¹ç›®æ ¹ç›®å½•ï¼Œ`Dockerfile`ã€`railway.toml`ã€`requirements.txt` éƒ½åœ¨æ ¹ç›®å½•ä¸‹ï¼Œä¸€åˆ‡å¯¹é½ã€‚

**æ–¹æ¡ˆ Bï¼ˆå¤‡é€‰ï¼‰ï¼šæŠŠ railway.toml ç§»åˆ°ä»“åº“æ ¹ç›®å½•**

```text
MiroThinker/
â”œâ”€â”€ railway.toml          # ç§»åˆ°è¿™é‡Œ
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ mcp-server/
â”‚       â”œâ”€â”€ Dockerfile    # ä¿æŒä¸åŠ¨
â”‚       â””â”€â”€ ...
â””â”€â”€ ...
```

æ ¹ç›®å½•çš„ `railway.toml`ï¼š

```toml
[build]
builder = "dockerfile"
dockerfilePath = "apps/mcp-server/Dockerfile"

[deploy]
healthcheckPath = "/sse"
healthcheckTimeout = 300
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3
```

ä½†è¿™æ ·è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šDockerfile çš„ `COPY . .` ä¼šæŠŠæ•´ä¸ªä»“åº“å¤åˆ¶è¿›å»ï¼ˆåŒ…æ‹¬åŸé¡¹ç›®çš„å¤§é‡æ–‡ä»¶ï¼‰ï¼Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚éœ€è¦ä¿®æ”¹ Dockerfile çš„ build context æˆ–ç”¨ `.dockerignore`ã€‚

**æ‰€ä»¥æ¨èæ–¹æ¡ˆ A**ï¼Œæœ€å¹²å‡€ã€‚

---

### æ“ä½œæ­¥éª¤

```
1. ç™»å½• Railway Dashboard
2. è¿›å…¥ä½ çš„ Service â†’ Settings â†’ Source åŒºåŸŸ
3. æ‰¾åˆ° "Root Directory" è®¾ç½®
4. å¡«å…¥: apps/mcp-server
5. ä¿å­˜

6. ä¿®æ”¹ apps/mcp-server/railway.toml:
   å°† dockerfilePath ä» "apps/mcp-server/Dockerfile" æ”¹ä¸º "Dockerfile"

7. æäº¤ä»£ç æ¨é€åˆ° GitHub
8. Railway è‡ªåŠ¨é‡æ–°éƒ¨ç½²
```