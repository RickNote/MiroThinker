# MiroThinker MCP é¡¹ç›®æ”¹é€ å®Œæ•´æŒ‡å—

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

å°† MiroThinker çš„ä¿¡æ¯æœç´¢æ•´ç†èƒ½åŠ›å°è£…æˆ MCP (Model Context Protocol) æœåŠ¡ï¼Œéƒ¨ç½²åœ¨ Railway ä¸Šï¼Œä½œä¸º Claude çš„"æŸ¥èµ„æ–™"èƒ½åŠ›æ‰©å±•ã€‚

### 1.2 æ¶æ„è®¾è®¡

```
Claudian (å®¢æˆ·ç«¯)
    â†“ SSE è¿æ¥
Railway æœåŠ¡å™¨ (MCP Server)
    â”œâ”€â†’ Serper API (Google æœç´¢)
    â”œâ”€â†’ Jina API (ç½‘é¡µæŠ“å–)
    â””â”€â†’ LLM API (DeepSeek ç­‰ç¬¬ä¸‰æ–¹å¤§æ¨¡å‹)
```

### 1.3 é¡¹ç›®æ–‡ä»¶ç»“æ„

```
MiroThinker/
â””â”€â”€ apps/
    â””â”€â”€ mcp-server/              # MCP æœåŠ¡åº”ç”¨
        â”œâ”€â”€ mcp_server.py        # MCP æœåŠ¡å…¥å£ + 4ä¸ªå·¥å…·æ³¨å†Œ
        â”œâ”€â”€ mcp_config.py        # ç¯å¢ƒå˜é‡é…ç½®ç®¡ç†
        â”œâ”€â”€ llm_client.py        # LLM ç»Ÿä¸€è°ƒç”¨å±‚
        â”œâ”€â”€ mcp_tools/
        â”‚   â”œâ”€â”€ __init__.py
        â”‚   â”œâ”€â”€ miro_search.py   # Serper æœç´¢
        â”‚   â”œâ”€â”€ miro_read.py     # Jina æŠ“å– + LLM æå–
        â”‚   â”œâ”€â”€ miro_summarize.py # LLM æ€»ç»“æ•´ç†
        â”‚   â””â”€â”€ miro_research.py # å¤šè½®ç³»ç»Ÿæ€§ç ”ç©¶
        â”œâ”€â”€ requirements.txt     # ä¾èµ–æ¸…å•
        â”œâ”€â”€ Dockerfile           # Docker æ„å»º
        â”œâ”€â”€ railway.toml         # Railway éƒ¨ç½²é…ç½®
        â””â”€â”€ .dockerignore        # Docker å¿½ç•¥æ–‡ä»¶
```

---

## äºŒã€æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 2.1 mcp_config.py - ç¯å¢ƒå˜é‡é…ç½®

**èŒè´£**ï¼šä»ç¯å¢ƒå˜é‡åŠ è½½å¹¶éªŒè¯é…ç½®

**é…ç½®é¡¹æ¸…å•**ï¼š

| é…ç½®é¡¹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|:----:|--------|------|
| `SERPER_API_KEY` | âœ… | â€” | Serper Google æœç´¢ API Key |
| `SERPER_BASE_URL` | âŒ | `https://google.serper.dev` | Serper API åœ°å€ |
| `JINA_API_KEY` | âœ… | â€” | Jina ç½‘é¡µæŠ“å– API Key |
| `JINA_BASE_URL` | âŒ | `https://r.jina.ai` | Jina API åœ°å€ |
| `LLM_API_KEY` | âœ… | â€” | ä¸» LLM API Key |
| `LLM_BASE_URL` | âœ… | â€” | ä¸» LLM åœ°å€ï¼ˆOpenAI SDK æ ¼å¼ï¼‰ |
| `LLM_MODEL` | âœ… | â€” | ä¸» LLM æ¨¡å‹å |
| `SUMMARY_LLM_API_KEY` | âŒ | å¤ç”¨ `LLM_API_KEY` | æ‘˜è¦ LLM Key |
| `SUMMARY_LLM_BASE_URL` | âŒ | å¤ç”¨ `LLM_BASE_URL` | æ‘˜è¦ LLM åœ°å€ |
| `SUMMARY_LLM_MODEL` | âŒ | å¤ç”¨ `LLM_MODEL` | æ‘˜è¦ LLM æ¨¡å‹å |
| `PORT` | âŒ | 8000 | æœåŠ¡ç«¯å£ï¼ˆRailway è‡ªåŠ¨æ³¨å…¥ï¼‰ |

**å…³é”®å®ç°**ï¼š
- å¯åŠ¨æ—¶éªŒè¯å¿…å¡«é¡¹ï¼Œç¼ºå¤±åˆ™æŠ›å‡ºæ¸…æ™°é”™è¯¯
- è‡ªåŠ¨æ£€æµ‹ `summary_llm_base_url` æ ¼å¼ï¼ˆæ˜¯å¦ä»¥ `/chat/completions` ç»“å°¾ï¼‰

---

### 2.2 llm_client.py - LLM ç»Ÿä¸€è°ƒç”¨å±‚

**èŒè´£**ï¼šå°è£…æ‰€æœ‰ LLM è°ƒç”¨ï¼Œå¤„ç†é‡è¯•ã€é”™è¯¯ã€æ ¼å¼è½¬æ¢

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```python
class LLMClient:
    async def chat(messages, role="main"|"summary", temperature, max_tokens) -> str
    async def chat_json(messages, role, ...) -> dict
    async def extract_info(content, info_to_extract) -> str
```

**å…³é”®ç‰¹æ€§**ï¼š
- ä¸» LLM ä½¿ç”¨ OpenAI SDK
- æ‘˜è¦ LLM æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
  - SDK æ¨¡å¼ï¼ˆOpenAI å…¼å®¹æ¥å£ï¼‰
  - ç›´è¿æ¨¡å¼ï¼ˆhttpx ç›´æ¥ POST åˆ°å®Œæ•´ URLï¼‰
- é‡è¯•ç­–ç•¥ï¼šæœ€å¤š 5 æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ [1, 2, 4, 8, 16] ç§’
- é‡å¤è¾“å‡ºæ£€æµ‹ï¼šå°¾éƒ¨ 50 å­—ç¬¦å‡ºç° >5 æ¬¡åˆ™é‡è¯•
- ä¸Šä¸‹æ–‡è¶…é™å¤„ç†ï¼šæˆªæ–­å†…å®¹åé‡è¯•
- `chat_json` ä¸ä¿®æ”¹åŸ messages åˆ—è¡¨ï¼ˆæ·±æ‹·è´ï¼‰

#### ä¸»LLM vs æ€»ç»“LLM è¯¦ç»†å¯¹æ¯”

| ç»´åº¦ | ä¸»LLM (Main LLM) | æ€»ç»“LLM (Summary LLM) |
|------|------------------|---------------------|
| **ç”¨é€”** | `miro_research` çš„æ¨ç†å¼•æ“ | `miro_read` å’Œ `miro_summarize` çš„å†…å®¹æå–/æ€»ç»“ |
| **èŒè´£** | ç ”ç©¶è§„åˆ’ã€ä¿¡æ¯è¯„ä¼°ã€æœç´¢è¯ç”Ÿæˆã€ç»“æœç»¼åˆ | ä»é•¿æ–‡æœ¬ä¸­æå–å…³é”®ä¿¡æ¯ã€æ•´ç†æ€»ç»“ |
| **å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦æ¨ç†ã€è§„åˆ’ã€åˆ¤æ–­ï¼‰ | ä½ï¼ˆä»…éœ€æå–ã€æ€»ç»“ï¼‰ |
| **é…ç½®é¡¹** | `LLM_API_KEY`, `LLM_BASE_URL`, `LLM_MODEL` | `SUMMARY_LLM_API_KEY`, `SUMMARY_LLM_BASE_URL`, `SUMMARY_LLM_MODEL` |
| **å¿…å¡«æ€§** | å¿…å¡«ï¼Œå¿…é¡»é…ç½® | å¯é€‰ï¼Œä¸å¡«åˆ™å¤ç”¨ä¸»LLM |
| **è°ƒç”¨æ¨¡å¼** | ä»… SDK æ¨¡å¼ | SDK æ¨¡å¼ æˆ– Direct æ¨¡å¼ |
| **æˆæœ¬è€ƒè™‘** | å»ºè®®ç”¨èƒ½åŠ›å¼ºçš„æ¨¡å‹ | å¯ä»¥ç”¨æ›´ä¾¿å®œçš„å°æ¨¡å‹ |

**æ€»ç»“LLMæ¨¡å¼åˆ¤æ–­é€»è¾‘**ï¼š
- å¦‚æœ `SUMMARY_LLM_BASE_URL` ä»¥ `/chat/completions` ç»“å°¾ â†’ Direct æ¨¡å¼ï¼ˆhttpx ç›´è¿ï¼‰
- å¦åˆ™ â†’ SDK æ¨¡å¼ï¼ˆOpenAI SDKï¼‰

**è®¾è®¡ç›®çš„**ï¼šå°†ä¸åŒç±»å‹çš„ä»»åŠ¡åˆ†å¼€ï¼Œä¸»LLMè´Ÿè´£å¤æ‚æ¨ç†ï¼Œæ€»ç»“LLMè´Ÿè´£ç®€å•çš„æå–å·¥ä½œï¼Œä»è€Œåœ¨ä¿è¯è´¨é‡çš„åŒæ—¶é™ä½æˆæœ¬ã€‚

---

### 2.3 miro_search.py - Serper æœç´¢

**èŒè´£**ï¼šå°è£… Serper Google æœç´¢

**æ ¸å¿ƒå‡½æ•°**ï¼š

```python
async def _raw_search(config, query, num_results, search_type, ctx) -> List[Dict]
    # è¿”å›ç»“æ„åŒ–æœç´¢ç»“æœï¼ˆä¸æ ¼å¼åŒ–ï¼‰

async def do_miro_search(config, query, num_results, search_type, ctx) -> str
    # è¿”å›æ ¼å¼åŒ–çš„ Markdown æ–‡æœ¬
```

**å…³é”®å®ç°**ï¼š
- Serper API ç«¯ç‚¹ï¼š`POST {SERPER_BASE_URL}/search`
- è¯·æ±‚å¤´ï¼š`X-API-KEY` + `Content-Type: application/json`
- è¿‡æ»¤ HuggingFace dataset/space çš„ URLï¼ˆé˜²æ­¢æ•°æ®æ³„æ¼ï¼‰
- URL è§£ç ï¼ˆ`url_unquote`ï¼‰
- å¦‚æœæ— ç»“æœä¸”æœç´¢è¯å¸¦å¼•å·ï¼Œè‡ªåŠ¨å»å¼•å·é‡è¯•
- é‡è¯•ç­–ç•¥ï¼š3 æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ (4s-10s)

---

### 2.4 miro_read.py - ç½‘é¡µæŠ“å–ä¸æå–

**èŒè´£**ï¼šJina æŠ“å– + Python fallback + LLM æå–

**æ ¸å¿ƒæµç¨‹**ï¼š

```
1. ç”¨ Jina æŠ“å–
   â†“ (å¤±è´¥)
2. Python ç›´æ¥æŠ“å– fallback
   â†“
3. å†…å®¹æˆªæ–­ï¼ˆæœ€å¤§ 409600 å­—ç¬¦ï¼‰
   â†“
4. åˆ¤æ–­æ˜¯å¦éœ€è¦ LLM æå–
   â”œâ”€ å†…å®¹ â‰¤6000 å­—ä¸” query ä¸ºç©º â†’ ç›´æ¥è¿”å›
   â””â”€ å¦åˆ™ â†’ ç”¨ LLM æå–å…³é”®ä¿¡æ¯
```

**å…³é”®å®ç°**ï¼š
- Jina APIï¼š`GET {JINA_BASE_URL}/{url}`
- Jina è¯·æ±‚å¤´ï¼š`Authorization: Bearer {JINA_API_KEY}`
- è¶…æ—¶ï¼šconnect=20s, read=60s
- é‡è¯•ï¼š[1, 2, 4, 8] ç§’
- æ£€æµ‹ `InsufficientBalanceError`ï¼ˆJina ä½™é¢ä¸è¶³ï¼‰
- é¿å…é‡å¤çš„ Jina URL å‰ç¼€
- LLM æå–å¤±è´¥æ—¶é™çº§è¿”å›æˆªæ–­åŸå§‹å†…å®¹

---

### 2.5 miro_summarize.py - LLM æ€»ç»“æ•´ç†

**èŒè´£**ï¼šç”¨ LLM æ•´ç†å’Œæ€»ç»“å¤§æ®µä¿¡æ¯

**æ ¸å¿ƒå‡½æ•°**ï¼š

```python
async def do_miro_summarize(config, llm_client, content, instruction, ctx) -> str
```

ä½¿ç”¨ `role="summary"`ï¼ˆæ‘˜è¦ LLMï¼ŒèŠ‚çœæˆæœ¬ï¼‰ï¼Œ`temperature=0.3`

---

### 2.6 miro_research.py - å¤šè½®ç³»ç»Ÿæ€§ç ”ç©¶

**èŒè´£**ï¼šè‡ªåŠ¨è¿›è¡Œå¤šè½®æœç´¢ã€é˜…è¯»å’Œä¿¡æ¯ç»¼åˆ

**æ ¸å¿ƒæµç¨‹**ï¼š

```
è½®æ¬¡ 1:
  LLM åˆ†æé—®é¢˜ â†’ ç”Ÿæˆ 5 ä¸ªæœç´¢è¯ï¼ˆå–å‰ 3 ä¸ªï¼‰
  æœç´¢ 1 â†’ é˜…è¯» 3 ä¸ªç½‘é¡µ
  æœç´¢ 2 â†’ é˜…è¯» 3 ä¸ªç½‘é¡µ
  æœç´¢ 3 â†’ é˜…è¯» 3 ä¸ªç½‘é¡µ
  å…±é˜…è¯» â‰¤9 ä¸ªç½‘é¡µ

è½®æ¬¡ 2-5:
  LLM è¯„ä¼°å·²æœ‰ä¿¡æ¯ï¼ˆåŸºäºçœŸå®å†…å®¹æ‘˜è¦ï¼‰
  â†’ å¦‚æœå……åˆ†ä¸”ç½®ä¿¡åº¦â‰¥70%: æå‰ç»“æŸ
  â†’ å¦‚æœä¸å¤Ÿ: è¾“å‡ºç¼ºå¤±æ–¹é¢ + 3 ä¸ªè¡¥å……æœç´¢è¯ + å»ºè®®æ·±å…¥é˜…è¯»çš„ URL
  å…ˆæ·±å…¥é˜…è¯»å»ºè®®çš„ URL
  å†æ‰§è¡Œè¡¥å……æœç´¢

æœ€ç»ˆç»¼åˆ:
  åŸºäºæ‰€æœ‰æ”¶é›†çš„ä¿¡æ¯ï¼Œç”Ÿæˆè°ƒæŸ¥ç»“æœæ±‡æ€»
```

**å…³é”®æ”¹è¿›ç‚¹ï¼ˆv7 æ–¹æ¡ˆï¼‰**ï¼š

| ç»´åº¦ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|--------|--------|
| é»˜è®¤è½®æ•° | 3 | 5 |
| æ¯è½®æœç´¢è¯ | 2 | 3 |
| æ¯æœç´¢è¯è¯»ç½‘é¡µ | 2 | 3 |
| å•æ¬¡ç ”ç©¶æœ€å¤§æœç´¢ | 6 æ¬¡ | 15 æ¬¡ |
| å•æ¬¡ç ”ç©¶æœ€å¤§é˜…è¯» | 12 ä¸ª | 45 ä¸ª |

**å…³é”®å®ç°**ï¼š
- `all_findings` è®°å½•çœŸå®å†…å®¹æ‘˜è¦ï¼ˆ300 å­—ï¼‰
- `findings_summary` å–å‰ 15 æ¡ï¼Œæ¯æ¡é™ 200 å­—
- æ”¹è¿›è¯„ä¼° Promptï¼Œå¢åŠ å¤šç»´åº¦åˆ†æï¼š
  - å½“å‰ä¿¡æ¯è¦†ç›–äº†å“ªäº›æ–¹é¢ï¼Ÿ
  - è¿˜ç¼ºå°‘å“ªäº›å…³é”®æ–¹é¢ï¼Ÿ
  - å·²æœ‰ä¿¡æ¯ä¹‹é—´æ˜¯å¦æœ‰çŸ›ç›¾éœ€è¦éªŒè¯ï¼Ÿ
  - ç”Ÿæˆé’ˆå¯¹å…·ä½“ç¼ºå¤±æ–¹é¢çš„è¡¥å……æœç´¢è¯
  - å»ºè®®éœ€è¦æ·±å…¥é˜…è¯»çš„ URL
- æå‰ç»“æŸé˜ˆå€¼ï¼š`is_sufficient == True` **ä¸”** `confidence >= 70`
- æ”¯æŒ `urls_to_deep_read` æ·±å…¥é˜…è¯»

---

### 2.7 mcp_server.py - MCP æœåŠ¡å…¥å£

**èŒè´£**ï¼šæ³¨å†Œ 4 ä¸ªå·¥å…·ï¼ŒSSE æ¨¡å¼å¯åŠ¨ï¼Œå¤„ç† CORS

**æ¶æ„å˜æ›´å†ç¨‹**ï¼š

| é˜¶æ®µ | æ–¹æ¡ˆ | é—®é¢˜ |
|------|------|------|
| v1 | FastMCP `.run()` | æ—  CORS æ”¯æŒ |
| v2 | FastMCP `.sse_app()` + CORS | `sse_app()` æ–¹æ³•ä¸å­˜åœ¨ |
| v3 | ç›´æ¥ç”¨ `mcp` SDK + Starlette | âœ… æˆåŠŸ |

**æœ€ç»ˆå®ç°**ï¼ˆv3ï¼‰ï¼š

```python
from mcp.server import Server
from mcp.server.sse import SseServerTransport
from starlette.applications import Starlette
from starlette.middleware.cors import CORSMiddleware

server = Server("MiroThinker")

# æ³¨å†Œ 4 ä¸ªå·¥å…·
# @server.list_tools()
# @server.call_tool()

sse = SseServerTransport("/messages/")

async def handle_sse(request):
    async with sse.connect_sse(...) as (read_stream, write_stream):
        await server.run(...)
    from starlette.responses import Response
    return Response()  # â† å…³é”®ï¼šå¿…é¡»è¿”å› Responseï¼

app = Starlette(routes=[...])
app.add_middleware(CORSMiddleware, allow_origins=["*"], ...)
```

**å…³é”®ä¿®å¤ç‚¹**ï¼š
- `handle_sse` å‡½æ•°å¿…é¡»è¿”å› `Response()` å¯¹è±¡ï¼Œå¦åˆ™ Starlette æŠ¥é”™ `TypeError: 'NoneType' object is not callable`
- æ·»åŠ  `/health` å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œä¾› Railway ä½¿ç”¨
- CORS ä¸­é—´ä»¶å…è®¸æ‰€æœ‰æ¥æºã€æ–¹æ³•ã€å¤´éƒ¨

---

## ä¸‰ã€ä¾èµ–æ¸…å•

**requirements.txt**ï¼š

```
fastmcp>=2.0.0,<3.0.0  # MCP æœåŠ¡å™¨æ¡†æ¶
mcp>=1.0.0              # MCP åè®®åŸºç¡€åº“
openai>=1.78.1          # ä¸» LLM è°ƒç”¨
httpx>=0.27.0           # å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
python-dotenv>=1.0.0    # åŠ è½½ .env æ–‡ä»¶
json-repair>=0.49.0     # ä¿®å¤ LLM ä¸è§„èŒƒ JSON
starlette>=0.36.0       # ASGI æ¡†æ¶
uvicorn>=0.30.0         # ASGI æœåŠ¡å™¨
```

---

## å››ã€å†å²é—®é¢˜ä¿®å¤è®°å½•

### é—®é¢˜ v1: ä»£ç å®¡æŸ¥é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ä¿®å¤ |
|------|---------|------|
| `miro_research` URL è§£æè„†å¼±ï¼ˆä» Markdown æå–ï¼‰ | ğŸ”´ ä¸¥é‡ | æ‹†åˆ† `_raw_search` è¿”å›ç»“æ„åŒ–æ•°æ® |
| `miro_research` ç¬¬ 2 è½®æœç´¢è¯é€€åŒ–ï¼ˆç¡¬ç¼–ç ï¼‰ | ğŸ”´ ä¸¥é‡ | å®ç° LLM è¯„ä¼°å’Œè¡¥å……æœç´¢è¯ç”Ÿæˆ |
| `chat_json` ä¿®æ”¹åŸ messages åˆ—è¡¨ | ğŸ”´ ä¸¥é‡ | æ·±æ‹·è´ messages |
| `miro_search` `data` å˜é‡å¯èƒ½æœªå®šä¹‰ | ğŸŸ¡ ä¸­ç­‰ | åˆå§‹åŒ– `data = {}` |
| åµŒå¥—é‡è¯•å¯¼è‡´æé•¿ç­‰å¾… | ğŸŸ¡ ä¸­ç­‰ | `extract_info` åªé’ˆå¯¹ä¸Šä¸‹æ–‡è¶…é™é‡è¯• |
| `miro_research` ç¼ºå°‘æ—¥å¿—æ¨é€ | ğŸŸ¡ ä¸­ç­‰ | è¡¥å……å…³é”®èŠ‚ç‚¹æ—¥å¿— |
| `miro_read` LLM æå–å¤±è´¥åç¼ºå°‘é™çº§ | ğŸŸ¢ è½»å¾® | é™çº§è¿”å›æˆªæ–­åŸå§‹å†…å®¹ |

---

### é—®é¢˜ v2-v3: Railway éƒ¨ç½²é—®é¢˜

**æ ¹æœ¬åŸå› **ï¼šRailway é»˜è®¤æŠŠä»“åº“æ ¹ç›®å½•ä½œä¸ºé¡¹ç›®æ ¹ç›®å½•ï¼Œæ‰¾ä¸åˆ° `apps/mcp-server/` ä¸‹çš„ `Dockerfile` å’Œ `railway.toml`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. Railway Dashboard â†’ Settings â†’ Source â†’ Root Directory å¡«å…¥ `apps/mcp-server`
2. ä¿®æ”¹ `railway.toml` ä¸­ `dockerfilePath` ä» `"apps/mcp-server/Dockerfile"` æ”¹ä¸º `"Dockerfile"`
3. Builder åˆ‡æ¢ä¸º `Dockerfile`ï¼ˆä¸æ˜¯ Railpackï¼‰

---

### é—®é¢˜ v4-v5: å¥åº·æ£€æŸ¥é—®é¢˜

**é—®é¢˜**ï¼šHealthcheck Path è®¾ä¸º `/sse`ï¼Œä½† SSE ç«¯ç‚¹ä¸é€‚åˆåšå¥åº·æ£€æŸ¥ï¼ˆé•¿è¿æ¥ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ·»åŠ ä¸“ç”¨ `/health` ç«¯ç‚¹ï¼Œè¿”å› `{"status": "ok"}`
2. Railway é…ç½®å’Œ `railway.toml` ä¸­ `healthcheckPath` æ”¹ä¸º `/health`

---

### é—®é¢˜ v6: CORS é—®é¢˜

**é—®é¢˜**ï¼šClaudian å‘ OPTIONS é¢„æ£€è¯·æ±‚ï¼Œè¿”å› 405 Method Not Allowed

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ·»åŠ  Starlette çš„ `CORSMiddleware`
2. é…ç½®ï¼š`allow_origins=["*"]`, `allow_methods=["*"]`, `allow_headers=["*"]`

---

### é—®é¢˜ v7: SSE handler è¿”å› None é—®é¢˜

**é—®é¢˜**ï¼š`handle_sse` å‡½æ•°æ²¡æœ‰è¿”å› Responseï¼ŒStarlette æŠ¥é”™ `TypeError: 'NoneType' object is not callable`

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ `handle_sse` å‡½æ•°æœ«å°¾æ·»åŠ ï¼š
```python
from starlette.responses import Response
return Response()
```

---

### é—®é¢˜ v8-v10: Claudian å®¢æˆ·ç«¯é—®é¢˜

**é—®é¢˜ 1**ï¼šå·¥å…·è°ƒç”¨ååŒ…å«è¿å­—ç¬¦ï¼ˆ`miro-thinker`ï¼‰å¯¼è‡´è·¯ç”±å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼šClaudian ä¸­ Service Name æ”¹ä¸º `miro`ï¼ˆå…¨å°å†™ï¼Œæ— è¿å­—ç¬¦ï¼‰

**é—®é¢˜ 2**ï¼šæ–°å¯¹è¯ä¸­ MCP å·¥å…·æœªè¢«å‹¾é€‰

**åŸå› **ï¼šClaudian è®¾è®¡ï¼šæ–°å¯¹è¯æ—¶é‡ç½® MCP å‹¾é€‰çŠ¶æ€ï¼ˆèŠ‚çœ Tokenï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¾“å…¥ `@miro` è‡ªåŠ¨å‹¾é€‰
- æˆ–æ‰‹åŠ¨åœ¨å¯¹è¯ä¸‹æ–¹å‹¾é€‰
- æ£€æŸ¥æ˜¯å¦å…³é—­äº† `Context-saving mode`

**é—®é¢˜ 3**ï¼š-32602 é”™è¯¯

**åŸå› **ï¼šSSE ä¼šè¯æ–­å¼€é‡è¿åæœªå®Œæˆåˆå§‹åŒ–æ¡æ‰‹

**è§£å†³æ–¹æ¡ˆ**ï¼šå¼€ä¸€ä¸ªå…¨æ–°å¯¹è¯ï¼Œé‡æ–°å‹¾é€‰ MCP

---

### é—®é¢˜ v13-v14: miro_research æ·±åº¦ä¸è¶³

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
- é»˜è®¤ `max_rounds`: 3 â†’ 5
- æ¯è½®æœç´¢è¯: [:2] â†’ [:3]
- æ¯æœç´¢è¯è¯»ç½‘é¡µ: [:2] â†’ [:3]
- `all_findings` è®°å½•çœŸå®å†…å®¹æ‘˜è¦ï¼ˆ300 å­—ï¼‰
- æ”¹è¿›è¯„ä¼° Promptï¼Œå¢åŠ å¤šç»´åº¦åˆ†æ
- æé«˜æå‰ç»“æŸç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆâ‰¥70%ï¼‰
- æ”¯æŒ `urls_to_deep_read` æ·±å…¥é˜…è¯»
- æ·»åŠ ç ”ç©¶è®¡åˆ’æ—¥å¿—æ¨é€

---

## äº”ã€å…³é”®ä»£ç ä½ç½®é€ŸæŸ¥

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|------|------|------|
| MCP Server åˆå§‹åŒ– | `mcp_server.py` | 29 |
| å·¥å…·å®šä¹‰ | `mcp_server.py` | 31-93 |
| `list_tools` handler | `mcp_server.py` | 97-99 |
| `call_tool` handler | `mcp_server.py` | 102-143 |
| SSE handler | `mcp_server.py` | 149-157 |
| å¥åº·æ£€æŸ¥ç«¯ç‚¹ | `mcp_server.py` | 160-161 |
| CORS ä¸­é—´ä»¶ | `mcp_server.py` | 172-178 |
| Config å®šä¹‰ | `mcp_config.py` | - |
| LLMClient å®šä¹‰ | `llm_client.py` | - |
| `_raw_search` å†…éƒ¨å‡½æ•° | `miro_search.py` | - |
| `do_miro_search` å…¥å£ | `miro_search.py` | - |
| `do_miro_read` å…¥å£ | `miro_read.py` | - |
| `do_miro_summarize` å…¥å£ | `miro_summarize.py` | - |
| `do_miro_research` å…¥å£ | `miro_research.py` | 84 |
| ç ”ç©¶ä¸»å¾ªç¯ | `miro_research.py` | 103-210 |
| è¯„ä¼°é€»è¾‘ | `miro_research.py` | 131-152 |
| æ·±å…¥é˜…è¯»å¤„ç† | `miro_research.py` | 154-174 |

---

## å…­ã€å¸¸è§é—®é¢˜æ’æŸ¥

### 6.1 æœåŠ¡å¯åŠ¨å¤±è´¥

| é”™è¯¯ | å¯èƒ½åŸå›  | æ’æŸ¥ |
|------|---------|------|
| `ValueError: SERPER_API_KEY is required` | ç¯å¢ƒå˜é‡æœªé…ç½® | æ£€æŸ¥ Railway Variables |
| `AttributeError: 'FastMCP' object has no attribute 'sse_app'` | ç”¨äº†æ—§ç‰ˆæœ¬ä»£ç  | ç¡®è®¤ç”¨çš„æ˜¯ç›´æ¥ mcp SDK æ–¹æ¡ˆ |
| `TypeError: 'NoneType' object is not callable` | `handle_sse` æ²¡è¿”å› Response | ç¡®è®¤æœ‰ `return Response()` |

### 6.2 éƒ¨ç½²å¤±è´¥

| é”™è¯¯ | å¯èƒ½åŸå›  | æ’æŸ¥ |
|------|---------|------|
| `skipping Dockerfile at apps/mcp-server/Dockerfile` | Root Directory æœªè®¾ç½® | æ£€æŸ¥ Railway Settings â†’ Root Directory = `apps/mcp-server` |
| Healthcheck failed | å¥åº·æ£€æŸ¥è·¯å¾„ä¸å¯¹ | ç¡®è®¤ `/health` ç«¯ç‚¹å­˜åœ¨ä¸”é…ç½®æ­£ç¡® |
| Build æˆåŠŸä½† Deploy å¤±è´¥ | ç¯å¢ƒå˜é‡ç¼ºå¤± | æ£€æŸ¥ Railway Variables é…ç½®äº†æ‰€æœ‰å¿…å¡«é¡¹ |

### 6.3 å·¥å…·è°ƒç”¨å¤±è´¥

| ç°è±¡ | å¯èƒ½åŸå›  | æ’æŸ¥ |
|------|---------|------|
| Claudian æ˜¾ç¤º "Connected" ä½†å·¥å…·ä¸åœ¨åˆ—è¡¨ | å¯¹è¯ä¸­æœªå‹¾é€‰ MCP | è¾“å…¥ `@miro` æˆ–æ‰‹åŠ¨å‹¾é€‰ |
| `Error: No such tool available` | Service Name åŒ…å«è¿å­—ç¬¦ | æ”¹ä¸º `miro`ï¼ˆå…¨å°å†™ï¼‰ |
| `-32602` é”™è¯¯ | SSE ä¼šè¯æ–­å¼€ | å¼€æ–°å¯¹è¯ |
| å·¥å…·æ‰§è¡Œä½†æ— æ—¥å¿— | æœåŠ¡ç«¯æŠ¥é”™ | æ£€æŸ¥ Railway Deploy Logs |

---

## ä¸ƒã€å·¥å…·ä½¿ç”¨ç¤ºä¾‹

### miro_search - ç®€å•æœç´¢

```
è¯·ä½¿ç”¨ miro_search æœç´¢ "2025 AI trends"
```

### miro_read - é˜…è¯»ç½‘é¡µ

```
è¯·ä½¿ç”¨ miro_read é˜…è¯» "https://example.com/article"
```

### miro_summarize - æ•´ç†ä¿¡æ¯

```
è¯·ä½¿ç”¨ miro_summarize æ•´ç†ä»¥ä¸‹å†…å®¹ï¼š
[å¤§æ®µæ–‡æœ¬]
```

### miro_research - ç³»ç»Ÿæ€§ç ”ç©¶

```
è¯·ä½¿ç”¨ miro_research ç ”ç©¶ "2026å¹´AI Agentå‘å±•è¶‹åŠ¿"
```

---

## å…«ã€é™„å½•ï¼šç¯å¢ƒå˜é‡æ¨¡æ¿ (.env.example)

```bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MiroThinker MCP Server ç¯å¢ƒå˜é‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€ å¿…å¡«: æœç´¢ â”€â”€
SERPER_API_KEY=your_serper_key_here
# SERPER_BASE_URL=https://google.serper.dev

# â”€â”€ å¿…å¡«: ç½‘é¡µæŠ“å– â”€â”€
JINA_API_KEY=your_jina_key_here
# JINA_BASE_URL=https://r.jina.ai

# â”€â”€ å¿…å¡«: ä¸» LLM â”€â”€
LLM_API_KEY=your_llm_api_key_here
LLM_BASE_URL=https://api.deepseek.com/v1
LLM_MODEL=deepseek-chat

# â”€â”€ å¯é€‰: æ‘˜è¦ LLM â”€â”€
# SUMMARY_LLM_API_KEY=
# SUMMARY_LLM_BASE_URL=
# SUMMARY_LLM_MODEL=
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-15
